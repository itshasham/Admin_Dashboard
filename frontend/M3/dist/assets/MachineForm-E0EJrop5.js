import{a as oe,r as d,j as e,A as N}from"./index-C1zVYYn4.js";/* empty css                */import{p as de}from"./api-error-Dgx8dn8F.js";const G={name:"",modelNumber:"",brand:"",productUrl:"",description:"",availability:"available",images:[],contactEmail:"",whatsappNumber:"",inquiryOnly:!0,isInquiryOnly:!0,professionalUseOnly:!0,isActive:!0},me=r=>Array.isArray(r)?r:!r||typeof r!="object"?[]:Array.isArray(r.data)?r.data:Array.isArray(r.brands)?r.brands:Array.isArray(r.result)?r.result:r.data&&Array.isArray(r.data.data)?r.data.data:r.data&&Array.isArray(r.data.result)?r.data.result:[],he=r=>!r||typeof r!="object"?[]:Array.isArray(r.images)?r.images:Array.isArray(r.data)?r.data:r.data&&Array.isArray(r.data.images)?r.data.images:[],A=r=>{const g=Array.isArray(r)?r:[],s=new Set,h=[];return g.forEach(m=>{const f=String(typeof m=="string"?m:(m==null?void 0:m.url)||(m==null?void 0:m.img)||"").trim();if(!f)return;const w=f.toLowerCase();s.has(w)||(s.add(w),h.push(f))}),h},X=r=>{try{const g=new URL(String(r||""));return g.protocol==="http:"||g.protocol==="https:"}catch{return!1}},fe=()=>{const{id:r}=oe(),g=!!r,[s,h]=d.useState(G),[m,f]=d.useState([]),[w,q]=d.useState(!1),[$,B]=d.useState(""),[L,P]=d.useState(!1),[R,k]=d.useState(!1),[T,v]=d.useState(""),[D,j]=d.useState([]),[I,F]=d.useState(!1),[C,z]=d.useState(!1),[_,p]=d.useState(""),[U,Y]=d.useState(""),[H,Q]=d.useState([]),[x,M]=d.useState({}),S=()=>{try{const a=localStorage.getItem("adminToken");return a?{Authorization:`Bearer ${a}`}:{}}catch{return{}}},Z=async()=>{q(!0);try{const a=await fetch(`${N}/brand/all`,{headers:{...S()},cache:"no-store"}),i=await a.json().catch(()=>null);if(!a.ok)throw new Error((i==null?void 0:i.message)||"Failed to load brands");const n=me(i).map((l,o)=>({id:(l==null?void 0:l._id)||(l==null?void 0:l.id)||(l==null?void 0:l.uuid)||`brand-${o}`,name:String((l==null?void 0:l.name)||(l==null?void 0:l.brandName)||(l==null?void 0:l.title)||"").trim()})).filter(l=>l.name);f(n)}catch{f([])}finally{q(!1)}},ee=async()=>{var a;if(g){P(!0),v(""),j([]);try{const i=await fetch(`${N}/machines/${r}`,{headers:{...S()},cache:"no-store"}),c=await i.json().catch(()=>null);if(!i.ok)throw new Error((c==null?void 0:c.message)||"Failed to load machine");const n=(c==null?void 0:c.data)||c,l=typeof(n==null?void 0:n.brand)=="string"?n.brand:((a=n==null?void 0:n.brand)==null?void 0:a.name)||"";h({...G,...n,brand:String(l||"").trim(),productUrl:String((n==null?void 0:n.productUrl)||"").trim(),images:A(n==null?void 0:n.images)})}catch(i){v(i.message||"Failed to load machine")}finally{P(!1)}}},y=async(a=U)=>{z(!0),p("");try{const i=new URL(`${N}/cloudinary/images`);String(a||"").trim()&&i.searchParams.set("q",String(a).trim());const c=await fetch(i.toString(),{headers:{...S()},cache:"no-store"}),n=await c.json().catch(()=>({}));if(!c.ok)throw new Error((n==null?void 0:n.message)||(n==null?void 0:n.error)||"Failed to load image manager");const l=he(n).map((t,O)=>({id:(t==null?void 0:t._id)||(t==null?void 0:t.publicId)||(t==null?void 0:t.id)||`manager-image-${O}`,publicId:(t==null?void 0:t.publicId)||(t==null?void 0:t.id)||"",url:String((t==null?void 0:t.url)||(t==null?void 0:t.img)||"").trim()})).filter(t=>t.url),o=new Map;l.forEach(t=>{o.has(t.url)||o.set(t.url,t)}),Q(Array.from(o.values()))}catch(i){p(i.message||"Failed to load image manager"),Q([])}finally{z(!1)}};d.useEffect(()=>{Z(),ee()},[r]),d.useEffect(()=>{I&&y()},[I]);const ae=d.useMemo(()=>new Set(m.map(a=>a.name)),[m]),u=a=>{const{name:i,value:c,type:n,checked:l}=a.target;if(n==="checkbox"){if(i==="inquiryOnly"){h(o=>({...o,inquiryOnly:l,isInquiryOnly:l}));return}h(o=>({...o,[i]:l}));return}h(o=>({...o,[i]:c}))},se=a=>{h(i=>({...i,brand:a.target.value}))},V=a=>{const i=A(a);i.length&&h(c=>({...c,images:A([...c.images||[],...i])}))},ie=()=>{const a=String($||"").trim();if(a){if(!X(a)){p("Please enter a valid image URL starting with http or https.");return}V([a]),B(""),p("")}},re=a=>{h(i=>({...i,images:(i.images||[]).filter((c,n)=>n!==a)}))},W=()=>{M({}),p(""),F(!0)},E=()=>{F(!1),M({}),p(""),Y("")},ne=a=>{const i=String(a||"").trim();i&&M(c=>({...c,[i]:!c[i]}))},le=()=>{const a=Object.keys(x).filter(i=>x[i]);if(!a.length){p("Select at least one image.");return}V(a),E()},b=Object.keys(x).filter(a=>x[a]).length,te=()=>{var i,c,n;const a=[];return(i=s.name)!=null&&i.trim()||a.push("Name is required"),(c=s.modelNumber)!=null&&c.trim()||a.push("Model number is required"),(n=s.description)!=null&&n.trim()||a.push("Description is required"),s.productUrl&&!X(s.productUrl)&&a.push("Product URL must be a valid link (http/https)"),!s.contactEmail&&!s.whatsappNumber&&a.push("Provide at least one contact method (Email or WhatsApp)"),a},ce=async a=>{a.preventDefault(),k(!0),v(""),j([]);const i=te();if(i.length){v(`Please fix ${i.length} field${i.length===1?"":"s"} and try again.`),j(i),k(!1),window.scrollTo({top:0,behavior:"smooth"});return}const c={name:s.name,modelNumber:s.modelNumber,brand:s.brand,productUrl:s.productUrl,description:s.description,availability:s.availability,images:A(s.images),contactEmail:s.contactEmail||"",whatsappNumber:s.whatsappNumber||"",inquiryOnly:!!s.inquiryOnly,isInquiryOnly:!!s.inquiryOnly,professionalUseOnly:!!s.professionalUseOnly,isActive:!!s.isActive};try{const n=g?`${N}/machines/${r}`:`${N}/machines`,o=await fetch(n,{method:g?"PUT":"POST",headers:{"Content-Type":"application/json",...S()},body:JSON.stringify(c)}),t=await o.json().catch(()=>({}));if(!o.ok){const O=o.status===401?"Your session has expired. Please log in again.":o.status===403?"You do not have permission to add or edit machines.":`Save failed (${o.status}). Please review and try again.`,K=de(t,O);v(K.summary),j(K.issues),window.scrollTo({top:0,behavior:"smooth"});return}window.location.href="/admin/machines"}catch(n){v(n.message||"Failed to save machine"),j([]),window.scrollTo({top:0,behavior:"smooth"})}finally{k(!1)}},J=Array.isArray(s.images)&&s.images.length?s.images[0]:"";return e.jsxs("div",{className:"page-container",children:[e.jsxs("div",{className:"page-header fancy",children:[e.jsxs("div",{children:[e.jsx("h2",{children:g?"Edit Machine":"Add Machine"}),e.jsx("p",{className:"muted",children:"Machines are inquiry-first listings for customer view."})]}),e.jsx("button",{className:"btn secondary",type:"button",onClick:()=>window.location.href="/admin/machines",children:"â† Back"})]}),T&&e.jsxs("div",{className:"error-panel",role:"alert","aria-live":"polite",children:[e.jsx("p",{className:"error-panel-title",children:T}),D.length>0&&e.jsx("ul",{className:"error-panel-list",children:D.map((a,i)=>e.jsx("li",{children:a},`${a}-${i}`))})]}),L&&e.jsx("div",{children:"Loading..."}),!L&&e.jsxs("div",{className:"product-form-shell",children:[e.jsxs("div",{className:"product-side",children:[e.jsxs("div",{className:"card product-preview-card",children:[e.jsx("div",{className:"product-preview-media",children:J?e.jsx("img",{src:J,alt:"Machine preview",onError:a=>{a.currentTarget.style.visibility="hidden"}}):e.jsx("div",{className:"preview-placeholder",children:"No image selected"})}),e.jsxs("div",{className:"product-preview-body",children:[e.jsx("span",{className:"product-preview-title",children:s.name||"Untitled Machine"}),e.jsxs("div",{className:"product-preview-row",children:[e.jsx("span",{children:"Model"}),e.jsx("strong",{children:s.modelNumber||"N/A"})]}),e.jsxs("div",{className:"product-preview-row",children:[e.jsx("span",{children:"Brand"}),e.jsx("strong",{children:s.brand||"Unassigned"})]}),e.jsxs("div",{className:"product-preview-row",children:[e.jsx("span",{children:"Availability"}),e.jsx("strong",{children:s.availability||"available"})]})]})]}),e.jsxs("div",{className:"card product-media-card",children:[e.jsxs("div",{className:"section-title",children:[e.jsx("h3",{children:"Media"}),e.jsx("span",{className:"hint",children:"Pick image URLs quickly from Image Manager"})]}),e.jsx("label",{children:"Machine Images"}),e.jsxs("div",{className:"actions",style:{marginTop:8},children:[e.jsx("button",{type:"button",className:"btn secondary",onClick:W,children:"Select from Image Manager"}),Array.isArray(s.images)&&s.images.length>0&&e.jsx("button",{type:"button",className:"btn ghost",onClick:()=>h(a=>({...a,images:[]})),children:"Clear All"})]}),e.jsxs("div",{className:"image-input-row image-input-row-three",style:{marginTop:10},children:[e.jsx("input",{type:"url",placeholder:"https://example.com/machine-image.jpg",value:$,onChange:a=>B(a.target.value)}),e.jsx("button",{type:"button",className:"btn ghost",onClick:ie,children:"Add URL"}),e.jsx("button",{type:"button",className:"btn secondary",onClick:W,children:"Browse"})]}),e.jsx("div",{className:"subtext",children:"You can add manual URLs or select multiple URLs from Image Manager."}),Array.isArray(s.images)&&s.images.length>0?e.jsx("div",{className:"image-grid",children:s.images.map((a,i)=>e.jsxs("div",{className:"image-tile",children:[e.jsx("img",{src:a,alt:`machine-${i+1}`}),e.jsx("button",{type:"button",className:"image-remove",onClick:()=>re(i),children:"x"})]},`${a}-${i}`))}):e.jsx("div",{className:"image-empty",children:"No machine images added yet."})]})]}),e.jsx("div",{className:"card compact product-form-card",children:e.jsxs("form",{onSubmit:ce,className:"product-form-grid",children:[e.jsxs("div",{className:"section appear",children:[e.jsxs("div",{className:"section-title",children:[e.jsx("h3",{children:"Basics"}),e.jsx("span",{className:"hint",children:"Core machine information"})]}),e.jsxs("div",{className:"form-table",children:[e.jsxs("div",{className:"form-row",children:[e.jsx("div",{className:"form-cell",children:"Name *"}),e.jsx("div",{className:"form-cell",children:e.jsx("input",{name:"name",value:s.name,onChange:u,required:!0})})]}),e.jsxs("div",{className:"form-row",children:[e.jsx("div",{className:"form-cell",children:"Model Number *"}),e.jsx("div",{className:"form-cell",children:e.jsx("input",{name:"modelNumber",value:s.modelNumber,onChange:u,required:!0})})]}),e.jsxs("div",{className:"form-row",children:[e.jsx("div",{className:"form-cell",children:"Brand"}),e.jsx("div",{className:"form-cell",children:e.jsxs("select",{value:s.brand||"",onChange:se,disabled:w,children:[e.jsx("option",{value:"",children:"-- Select brand --"}),m.map(a=>e.jsx("option",{value:a.name,children:a.name},a.id)),!ae.has(s.brand)&&s.brand?e.jsxs("option",{value:s.brand,children:[s.brand," (existing)"]}):null]})})]}),e.jsxs("div",{className:"form-row",children:[e.jsx("div",{className:"form-cell",children:"Original Product URL"}),e.jsx("div",{className:"form-cell",children:e.jsx("input",{type:"url",name:"productUrl",value:s.productUrl||"",onChange:u,placeholder:"https://brand-website.com/product-page"})})]}),e.jsxs("div",{className:"form-row",children:[e.jsx("div",{className:"form-cell",children:"Description *"}),e.jsx("div",{className:"form-cell",children:e.jsx("textarea",{name:"description",rows:4,value:s.description,onChange:u,required:!0})})]}),e.jsxs("div",{className:"form-row",children:[e.jsx("div",{className:"form-cell",children:"Availability"}),e.jsx("div",{className:"form-cell",children:e.jsxs("select",{name:"availability",value:s.availability,onChange:u,children:[e.jsx("option",{value:"available",children:"available"}),e.jsx("option",{value:"out-of-stock",children:"out-of-stock"}),e.jsx("option",{value:"discontinued",children:"discontinued"})]})})]})]})]}),e.jsxs("div",{className:"section appear delay-1",children:[e.jsxs("div",{className:"section-title",children:[e.jsx("h3",{children:"Inquiry Contact"}),e.jsx("span",{className:"hint",children:"At least one contact is required"})]}),e.jsxs("div",{className:"form-table",children:[e.jsxs("div",{className:"form-row",children:[e.jsx("div",{className:"form-cell",children:"Contact Email"}),e.jsx("div",{className:"form-cell",children:e.jsx("input",{type:"email",name:"contactEmail",value:s.contactEmail,onChange:u,placeholder:"sales@example.com"})})]}),e.jsxs("div",{className:"form-row",children:[e.jsx("div",{className:"form-cell",children:"WhatsApp Number"}),e.jsx("div",{className:"form-cell",children:e.jsx("input",{name:"whatsappNumber",value:s.whatsappNumber,onChange:u,placeholder:"923001234567"})})]}),e.jsxs("div",{className:"form-row",children:[e.jsx("div",{className:"form-cell",children:"Inquiry Only"}),e.jsx("div",{className:"form-cell",children:e.jsx("input",{type:"checkbox",name:"inquiryOnly",checked:!!s.inquiryOnly,onChange:u})})]}),e.jsxs("div",{className:"form-row",children:[e.jsx("div",{className:"form-cell",children:"Professional Use Only"}),e.jsx("div",{className:"form-cell",children:e.jsx("input",{type:"checkbox",name:"professionalUseOnly",checked:!!s.professionalUseOnly,onChange:u})})]}),e.jsxs("div",{className:"form-row",children:[e.jsx("div",{className:"form-cell",children:"Active"}),e.jsx("div",{className:"form-cell",children:e.jsx("input",{type:"checkbox",name:"isActive",checked:!!s.isActive,onChange:u})})]})]})]}),e.jsx("div",{className:"sticky-actions",style:{gridColumn:"1 / -1"},children:e.jsxs("div",{className:"actions",children:[e.jsx("button",{className:"btn",type:"submit",disabled:R,children:R?"Saving...":"Save Machine"}),e.jsx("button",{className:"btn secondary",type:"button",onClick:()=>window.location.href="/admin/machines",children:"Cancel"})]})})]})})]}),I&&e.jsx("div",{className:"image-manager-modal-overlay",role:"dialog","aria-modal":"true",onClick:E,children:e.jsxs("div",{className:"image-manager-modal-card",onClick:a=>a.stopPropagation(),children:[e.jsxs("div",{className:"section-title",children:[e.jsx("h3",{children:"Select Machine Images"}),e.jsx("span",{className:"hint",children:"Select multiple images, then click Done to add URLs."})]}),e.jsxs("div",{className:"image-input-row image-input-row-three",children:[e.jsx("input",{value:U,onChange:a=>Y(a.target.value),onKeyDown:a=>{a.key==="Enter"&&(a.preventDefault(),y(a.currentTarget.value))},placeholder:"Search by image id or URL"}),e.jsx("button",{type:"button",className:"btn ghost",onClick:()=>y(U),disabled:C,children:C?"Loading...":"Search"}),e.jsx("button",{type:"button",className:"btn secondary",onClick:E,children:"Close"})]}),_&&e.jsx("div",{className:"error",style:{marginTop:8},children:_}),e.jsx("div",{className:"image-manager-modal-body",children:e.jsxs("div",{className:"image-manager-grid",children:[H.map((a,i)=>e.jsxs("button",{type:"button",className:`image-tile selectable ${x[a.url]?"selected":""}`,onClick:()=>ne(a.url),children:[e.jsx("img",{src:a.url,alt:a.publicId||`manager-image-${i+1}`}),e.jsx("span",{className:"image-select-chip",children:x[a.url]?"Selected":"Select"})]},`${a.id}-${i}`)),!C&&!H.length&&e.jsx("div",{className:"image-empty",children:"No images found in image manager."})]})}),e.jsxs("div",{className:"image-manager-modal-footer",children:[e.jsxs("span",{className:"subtext",children:[b," selected"]}),e.jsx("button",{type:"button",className:"btn",onClick:le,disabled:!b,children:b?b===1?"Done (1 image)":`Done (${b} images)`:"Done"})]})]})})]})};export{fe as default};
