import{r as c,j as t,A as x}from"./index-C1zVYYn4.js";import{p as O}from"./api-error-Dgx8dn8F.js";const z=()=>{const[v,N]=c.useState(null),[M,w]=c.useState([]),[d,u]=c.useState(!1),[S,C]=c.useState(""),[k,A]=c.useState([]),[j,h]=c.useState([]),[g,D]=c.useState(""),[I,E]=c.useState(""),p=()=>{C(""),A([])},i=(e,a=[])=>{C(String(e||"").trim()||"Something went wrong."),A(Array.isArray(a)?a.filter(Boolean):[])},B=()=>{try{localStorage.removeItem("adminToken"),localStorage.removeItem("adminData")}catch{}window.location.href="/admin/login"},f=e=>e&&(e.name==="TypeError"||e instanceof TypeError)&&/failed to fetch/i.test(String(e.message||"")),y=(e,a,s)=>{const r=Number((e==null?void 0:e.status)||0);if(r===401){i("You are not logged in (session expired).",["Please log in again and retry."]),B();return}if(r===403){i("Access denied for Image Manager.",["Your account must be Admin, Manager, or CEO to manage images.","Ask your administrator to update your role."]);return}if(r===413){i("This file is too large to upload.",["Try a smaller image (recommended under 5 MB).","Use JPG/PNG/WebP and resize if needed."]);return}if(r===429){i("Too many requests.",["Please wait 30 seconds and try again."]);return}const n=O(a,s),o=String((a==null?void 0:a.message)||(a==null?void 0:a.error)||"").toLowerCase();if(r>=500&&(o.includes("cloudinary")||o.includes("api_key")||o.includes("cloud_name")||o.includes("api secret"))){i("Image service is not configured on the server.",["This is a backend setup issue (Cloudinary keys).","Contact the developer to verify Cloudinary environment variables on the backend deployment."]);return}i(n.summary,n.issues)},U=(e,{maxCount:a=1}={})=>{const n=Array.from(e||[]).slice(0,a),o=[];return n.length===0?(o.push("Please choose an image file."),{ok:!1,problems:o,files:[]}):(n.forEach((l,L)=>{if(!l)return;const T=l.name||`file ${L+1}`;String(l.type||"").startsWith("image/")||o.push(`${T}: Not an image file. Please select JPG/PNG/WebP.`),Number(l.size||0)>5242880&&o.push(`${T}: Too large. Please keep images under 5 MB.`)}),{ok:o.length===0,problems:o,files:n})},m=()=>{try{const e=localStorage.getItem("adminToken");return e?{Authorization:`Bearer ${e}`}:{}}catch{return{}}};c.useEffect(()=>{try{const e=localStorage.getItem("adminData"),a=e?JSON.parse(e):null;E(String((a==null?void 0:a.role)||""))}catch{E("")}},[]);const b=async()=>{p();try{const e=new URL(`${x}/cloudinary/images`);g.trim()&&e.searchParams.set("q",g.trim());const a=await fetch(e.toString(),{headers:{...m()},cache:"no-store"}),s=await a.json().catch(()=>({}));if(!a.ok){y(a,s,"Could not load images. Please try again."),h([]);return}const r=Array.isArray(s==null?void 0:s.images)?s.images:Array.isArray(s==null?void 0:s.data)?s.data:[];h(r)}catch(e){f(e)?i("Cannot connect to the server.",["Check your internet connection and try Refresh.","If it still fails, the backend may be down or blocked by the browser/network."]):i(e.message||"Failed to load images"),h([])}};c.useEffect(()=>{b()},[]);const $=async e=>{e.preventDefault();const a=U(v?[v]:[],{maxCount:1});if(!a.ok){i("Cannot upload image.",a.problems);return}u(!0),p();try{const s=new FormData;s.append("image",a.files[0]);const r=await fetch(`${x}/cloudinary/add-img`,{method:"POST",headers:{...m()},body:s}),n=await r.json().catch(()=>({}));if(!r.ok){y(r,n,"Upload failed. Please try again.");return}const o=(n==null?void 0:n.data)||n;h(l=>[o,...l]),N(null),await b()}catch(s){f(s)?i("Upload failed because the server could not be reached.",["Check your internet connection.","Try again in a few seconds."]):i(s.message||"Upload failed")}finally{u(!1)}},F=async e=>{e.preventDefault();const a=U(M||[],{maxCount:5});if(!a.ok){i("Cannot upload images.",a.problems);return}u(!0),p();try{const s=new FormData;a.files.forEach(l=>s.append("images",l));const r=await fetch(`${x}/cloudinary/add-multiple-img`,{method:"POST",headers:{...m()},body:s}),n=await r.json().catch(()=>({}));if(!r.ok){y(r,n,"Upload failed. Please try again.");return}const o=(n==null?void 0:n.data)||[];h(l=>[...o,...l]),w([]),await b()}catch(s){f(s)?i("Upload failed because the server could not be reached.",["Check your internet connection.","Try again in a few seconds."]):i(s.message||"Upload failed")}finally{u(!1)}},R=async e=>{const a=String(e||"");if(a)try{await navigator.clipboard.writeText(a)}catch{const s=document.createElement("textarea");s.value=a,s.style.position="fixed",s.style.opacity="0",document.body.appendChild(s),s.select(),document.execCommand("copy"),document.body.removeChild(s)}},_=async e=>{const a=(e==null?void 0:e._id)||(e==null?void 0:e.publicId);if(a&&window.confirm("Delete this image?")){u(!0),p();try{const s=encodeURIComponent(String(a)),r=await fetch(`${x}/cloudinary/images/${s}`,{method:"DELETE",headers:{...m()}}),n=await r.json().catch(()=>({}));if(!r.ok){y(r,n,"Delete failed. Please try again.");return}h(o=>o.filter(l=>((l==null?void 0:l._id)||(l==null?void 0:l.publicId))!==a))}catch(s){f(s)?i("Delete failed because the server could not be reached.",["Check your internet connection and try again."]):i(s.message||"Delete failed")}finally{u(!1)}}},P=c.useMemo(()=>{const e=g.trim().toLowerCase();return e?j.filter(a=>[a==null?void 0:a.publicId,a==null?void 0:a.folder,a==null?void 0:a.url].filter(Boolean).join(" ").toLowerCase().includes(e)):j},[j,g]);return I&&!["CEO","Manager","Admin"].includes(I)?t.jsx("div",{className:"page-container",children:t.jsx("div",{className:"error",children:"Access denied"})}):t.jsxs("div",{className:"page-container",children:[t.jsxs("div",{className:"page-header fancy",children:[t.jsxs("div",{children:[t.jsx("h2",{children:"Image Manager"}),t.jsx("p",{className:"muted",children:"Upload, copy URLs, and reuse images for products"})]}),t.jsx("div",{className:"actions",children:t.jsx("button",{className:"btn secondary",onClick:()=>window.location.href="/admin/dashboard",children:"â† Back"})})]}),S&&t.jsxs("div",{className:"error-panel",role:"alert","aria-live":"polite",children:[t.jsx("p",{className:"error-panel-title",children:S}),k.length>0&&t.jsx("ul",{className:"error-panel-list",children:k.map((e,a)=>t.jsx("li",{children:e},`${e}-${a}`))})]}),t.jsxs("div",{className:"grid two-col gap-16",children:[t.jsxs("div",{className:"card",children:[t.jsx("h3",{children:"Single Upload"}),t.jsxs("form",{onSubmit:$,className:"grid",style:{gap:12},children:[t.jsx("input",{type:"file",accept:"image/*",onChange:e=>{var a;return N(((a=e.target.files)==null?void 0:a[0])||null)}}),t.jsx("button",{className:"btn",type:"submit",disabled:d,children:d?"Uploading...":"Upload Image"})]})]}),t.jsxs("div",{className:"card",children:[t.jsx("h3",{children:"Multiple Upload (max 5)"}),t.jsxs("form",{onSubmit:F,className:"grid",style:{gap:12},children:[t.jsx("input",{multiple:!0,type:"file",accept:"image/*",onChange:e=>w(e.target.files||[])}),t.jsx("button",{className:"btn",type:"submit",disabled:d,children:d?"Uploading...":"Upload Images"})]})]})]}),t.jsxs("div",{className:"card",style:{marginTop:16},children:[t.jsxs("div",{className:"card-header",children:[t.jsx("h3",{style:{margin:0},children:"All Images"}),t.jsxs("div",{className:"actions",children:[t.jsx("input",{value:g,onChange:e=>D(e.target.value),placeholder:"Search by folder / id / url",style:{padding:"10px 12px",borderRadius:10,border:"1px solid var(--border)"}}),t.jsx("button",{className:"btn secondary",onClick:b,disabled:d,children:"Refresh"})]})]}),t.jsxs("div",{className:"gallery",children:[P.map((e,a)=>t.jsxs("div",{className:"gallery-item fade-in",children:[t.jsx("img",{src:(e==null?void 0:e.url)||"",alt:(e==null?void 0:e.publicId)||"upload",onError:s=>{s.currentTarget.style.visibility="hidden"}}),t.jsxs("div",{className:"gallery-meta",children:[t.jsx("div",{className:"meta-id",title:(e==null?void 0:e.publicId)||"",children:(e==null?void 0:e.publicId)||""}),t.jsxs("div",{className:"gallery-actions",children:[t.jsx("button",{className:"btn secondary",onClick:()=>R(e==null?void 0:e.url),children:"Copy URL"}),t.jsx("button",{className:"btn danger",onClick:()=>_(e),disabled:d,children:"Delete"})]})]})]},(e==null?void 0:e._id)||(e==null?void 0:e.publicId)||a)),!P.length&&t.jsx("div",{className:"muted",children:"No images found"})]})]})]})};export{z as default};
