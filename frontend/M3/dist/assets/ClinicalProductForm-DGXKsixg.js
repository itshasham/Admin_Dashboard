import{a as fe,r as m,j as e,A as f}from"./index-C1zVYYn4.js";/* empty css                */import{p as je}from"./api-error-Dgx8dn8F.js";const ae={img:"",title:"",parent:"Clinical",children:"",unit:"n/a",price:0,discount:0,quantity:0,status:"in-stock",brand:{name:"",id:""},category:{name:"",id:""},description:"",imageURLs:[],contactEmail:"",whatsappNumber:"",inquiryOnly:!0,isInquiryOnly:!0,professionalUseOnly:!0},P=[{id:"111111111111111111111111",name:"Filler"},{id:"222222222222222222222222",name:"Booster"},{id:"333333333333333333333333",name:"Premium Products"},{id:"444444444444444444444444",name:"Thread"}],se=s=>{const h=String((s==null?void 0:s.id)||"").trim(),i=String((s==null?void 0:s.name)||"").trim().toLowerCase();return P.find(o=>o.id===h||o.name.toLowerCase()===i)||null},xe=s=>s?Array.isArray(s)?s:Array.isArray(s.result)?s.result:Array.isArray(s.data)?s.data:s.data&&Array.isArray(s.data.result)?s.data.result:s.data&&Array.isArray(s.data.data)?s.data.data:[]:[],ve=s=>!s||typeof s!="object"?[]:Array.isArray(s.images)?s.images:Array.isArray(s.data)?s.data:s.data&&Array.isArray(s.data.images)?s.data.images:[],ie=s=>{const h=typeof s=="string"?s:(s==null?void 0:s.img)||(s==null?void 0:s.url)||"",i=String(h||"").trim();return i?{...typeof s=="object"&&s?s:{},img:i,color:typeof s=="object"&&(s==null?void 0:s.color)||{name:"default",clrCode:""},sizes:typeof s=="object"&&Array.isArray(s==null?void 0:s.sizes)&&s.sizes||[]}:null},S=s=>{const h=Array.isArray(s)?s:[],i=new Set,o=[];return h.forEach(I=>{const p=ie(I);if(!(p!=null&&p.img))return;const b=p.img.toLowerCase();i.has(b)||(i.add(b),o.push(p))}),o},Ce=()=>{var V,X;const{id:s}=fe(),h=!!s,[i,o]=m.useState(ae),[I,p]=m.useState([]),[b,B]=m.useState(!1),[T,k]=m.useState(!1),[re,F]=m.useState(!1),[D,x]=m.useState(""),[_,A]=m.useState([]),[L,z]=m.useState(!1),[E,Y]=m.useState("additional"),[O,H]=m.useState(!1),[J,w]=m.useState(""),[R,K]=m.useState(""),[Q,W]=m.useState([]),[v,M]=m.useState({}),N=()=>{try{const a=localStorage.getItem("adminToken");return a?{Authorization:`Bearer ${a}`}:{}}catch{return{}}},te=a=>{const r=Array.isArray(a)?a.map(t=>String(t||"").trim()).filter(Boolean):[];r.length&&o(t=>{const l=S(t.imageURLs),c=new Set(l.map(n=>n.img.toLowerCase())),d=[...l];return r.forEach(n=>{const u=n.toLowerCase();c.has(u)||(c.add(u),d.push(ie(n)))}),{...t,imageURLs:d}})},ne=async()=>{F(!0);try{const a=await fetch(`${f}/brand/all`,{headers:{...N()},cache:"no-store"}),r=await a.json().catch(()=>null);if(!a.ok)throw new Error((r==null?void 0:r.message)||"Failed to load brands");p(xe(r))}catch{p([])}finally{F(!1)}},le=async()=>{if(h){B(!0),x("");try{let a=await fetch(`${f}/clinical-products/${s}`,{headers:{...N()},cache:"no-store"}),r=await a.json().catch(()=>({}));if(!a.ok&&a.status===404&&(a=await fetch(`${f}/product/single-product/${s}`,{headers:{...N()},cache:"no-store"}),r=await a.json().catch(()=>({}))),!a.ok)throw new Error((r==null?void 0:r.message)||"Failed to load clinical product");const t=(r==null?void 0:r.data)||r,l=se(t==null?void 0:t.category);o({...ae,...t,brand:(t==null?void 0:t.brand)||{name:"",id:""},category:l||{name:"",id:""},parent:"Clinical",children:(l==null?void 0:l.name)||"",imageURLs:S(t==null?void 0:t.imageURLs)})}catch(a){x(a.message||"Failed to load clinical product")}finally{B(!1)}}},$=async(a=R)=>{H(!0),w("");try{const r=new URL(`${f}/cloudinary/images`);String(a||"").trim()&&r.searchParams.set("q",String(a).trim());const t=await fetch(r.toString(),{headers:{...N()},cache:"no-store"}),l=await t.json().catch(()=>({}));if(!t.ok)throw new Error((l==null?void 0:l.message)||(l==null?void 0:l.error)||"Failed to load image manager");const c=ve(l).map((n,u)=>({id:(n==null?void 0:n._id)||(n==null?void 0:n.publicId)||(n==null?void 0:n.id)||`manager-image-${u}`,publicId:(n==null?void 0:n.publicId)||(n==null?void 0:n.id)||"",url:String((n==null?void 0:n.url)||(n==null?void 0:n.img)||"").trim()})).filter(n=>n.url),d=new Map;c.forEach(n=>{d.has(n.url)||d.set(n.url,n)}),W(Array.from(d.values()))}catch(r){w(r.message||"Failed to load image manager"),W([])}finally{H(!1)}};m.useEffect(()=>{ne(),le()},[s]),m.useEffect(()=>{L&&$()},[L]);const j=a=>{const{name:r,value:t,type:l,checked:c}=a.target;if(l==="checkbox"){o(d=>({...d,[r]:c}));return}o(d=>({...d,[r]:t}))},ce=a=>{const r=a.target.value,t=I.find(c=>(c._id||c.id||c.uuid)===r),l=t?{id:t._id||t.id||t.uuid||"",name:t.name||t.parent||t.title||""}:{id:"",name:""};o(c=>({...c,brand:l}))},oe=a=>{const r=a.target.value,t=P.find(l=>l.id===r);if(!t){o(l=>({...l,category:{id:"",name:""},children:""}));return}o(l=>({...l,category:{id:t.id,name:t.name},children:t.name,parent:"Clinical"}))},de=a=>{o(r=>({...r,imageURLs:S(r.imageURLs).filter((t,l)=>l!==a)}))},G=(a="additional")=>{Y(a==="main"?"main":"additional"),M({}),w(""),z(!0)},U=()=>{z(!1),Y("additional"),M({}),w(""),K("")},me=a=>{const r=String(a||"").trim();if(r){if(E==="main"){o(t=>({...t,img:r})),U();return}M(t=>({...t,[r]:!t[r]}))}},ue=()=>{if(E==="main")return;const a=Object.keys(v).filter(r=>v[r]);if(!a.length){w("Select at least one image.");return}te(a),U()},C=Object.keys(v).filter(a=>v[a]).length,y=E==="main",he=()=>{var r,t,l,c,d,n,u;const a=[];return(r=i.img)!=null&&r.trim()||a.push("Main image URL is required"),(t=i.title)!=null&&t.trim()||a.push("Title is required"),(l=i.description)!=null&&l.trim()||a.push("Description is required"),(!((c=i.brand)!=null&&c.id)||!((d=i.brand)!=null&&d.name))&&a.push("Brand is required"),(!((n=i.category)!=null&&n.id)||!((u=i.category)!=null&&u.name))&&a.push("Category is required"),se(i.category)||a.push("Category must be one of Filler, Booster, Premium Products, or Thread"),!i.contactEmail&&!i.whatsappNumber&&a.push("Provide at least one contact method (Email or WhatsApp)"),a},ge=async a=>{var n;a.preventDefault(),k(!0),x(""),A([]);const r=he();if(r.length){x("Please fix the highlighted clinical product details before saving."),A(r),k(!1),window.scrollTo({top:0,behavior:"smooth"});return}const t=Number(i.price),l=Number(i.discount),c=Number(i.quantity),d={img:i.img,title:i.title,parent:"Clinical",children:String(i.children||((n=i.category)==null?void 0:n.name)||"").trim(),unit:String(i.unit||"").trim()||"n/a",price:Number.isFinite(t)?t:0,discount:Number.isFinite(l)?l:0,quantity:Number.isFinite(c)?c:0,status:i.status||"in-stock",brand:i.brand,category:i.category,productType:"clinical",description:i.description,imageURLs:S(i.imageURLs),contactEmail:i.contactEmail||"",whatsappNumber:i.whatsappNumber||"",inquiryOnly:!!i.inquiryOnly,isInquiryOnly:!!i.isInquiryOnly,professionalUseOnly:!!i.professionalUseOnly};try{let u=h?`${f}/clinical-products/${s}`:`${f}/clinical-products`,q=h?"PUT":"POST",g=await fetch(u,{method:q,headers:{"Content-Type":"application/json",...N()},body:JSON.stringify(d)}),Z=await g.json().catch(()=>({}));if(!g.ok&&g.status===404&&(u=h?`${f}/product/edit-product/${s}`:`${f}/product/add`,q=h?"PATCH":"POST",g=await fetch(u,{method:q,headers:{"Content-Type":"application/json",...N()},body:JSON.stringify(d)}),Z=await g.json().catch(()=>({}))),!g.ok){const pe=g.status===401?"Your session has expired. Please log in again.":g.status===403?"You do not have permission to add or edit clinical products.":`Save failed (${g.status}). Please review and try again.`,ee=je(Z,pe);x(ee.summary),A(ee.issues),window.scrollTo({top:0,behavior:"smooth"});return}window.location.href="/admin/clinical-products"}catch(u){x(u.message||"Failed to save clinical product"),A([]),window.scrollTo({top:0,behavior:"smooth"})}finally{k(!1)}};return e.jsxs("div",{className:"page-container",children:[e.jsxs("div",{className:"page-header fancy",children:[e.jsxs("div",{children:[e.jsx("h2",{children:h?"Edit Clinical Product":"Add Clinical Product"}),e.jsx("p",{className:"muted",children:"Clinical products are displayed to customers as inquiry-first items."})]}),e.jsx("button",{className:"btn secondary",type:"button",onClick:()=>window.location.href="/admin/clinical-products",children:"â† Back"})]}),b&&e.jsx("div",{children:"Loading..."}),D&&e.jsxs("div",{className:"error-panel",role:"alert","aria-live":"polite",children:[e.jsx("p",{className:"error-panel-title",children:D}),_.length>0&&e.jsx("ul",{className:"error-panel-list",children:_.map((a,r)=>e.jsx("li",{children:a},`${a}-${r}`))})]}),!b&&e.jsxs("div",{className:"product-form-shell",children:[e.jsxs("div",{className:"product-side",children:[e.jsxs("div",{className:"card product-preview-card",children:[e.jsx("div",{className:"product-preview-media",children:i.img?e.jsx("img",{src:i.img,alt:"Clinical product preview",onError:a=>{a.currentTarget.style.visibility="hidden"}}):e.jsx("div",{className:"preview-placeholder",children:"No main image"})}),e.jsxs("div",{className:"product-preview-body",children:[e.jsx("span",{className:"product-preview-title",children:i.title||"Untitled Clinical Product"}),e.jsxs("div",{className:"product-preview-row",children:[e.jsx("span",{children:"Brand"}),e.jsx("strong",{children:((V=i.brand)==null?void 0:V.name)||"Unassigned"})]}),e.jsxs("div",{className:"product-preview-row",children:[e.jsx("span",{children:"Category"}),e.jsx("strong",{children:((X=i.category)==null?void 0:X.name)||"Unassigned"})]})]})]}),e.jsxs("div",{className:"card product-media-card",children:[e.jsxs("div",{className:"section-title",children:[e.jsx("h3",{children:"Media"}),e.jsx("span",{className:"hint",children:"Use the same image flow as products"})]}),e.jsx("label",{children:"Main Image URL *"}),e.jsxs("div",{className:"image-input-row image-main-url-row",children:[e.jsx("input",{name:"img",placeholder:"https://example.com/image.jpg",value:i.img,onChange:j}),e.jsx("button",{type:"button",className:"btn secondary",onClick:()=>G("main"),children:"Select Image URL"})]}),e.jsx("div",{className:"preview-row",children:e.jsx("div",{className:"preview",children:i.img?e.jsx("img",{src:i.img,alt:"Main Image Preview",onError:a=>{a.currentTarget.style.visibility="hidden"}}):e.jsx("div",{className:"preview-placeholder",children:"No main image"})})}),e.jsx("label",{children:"Additional Images"}),e.jsxs("div",{className:"actions",style:{marginTop:8},children:[e.jsx("button",{type:"button",className:"btn secondary",onClick:()=>G("additional"),children:"Select Multiple Images"}),Array.isArray(i.imageURLs)&&i.imageURLs.length>0&&e.jsx("button",{type:"button",className:"btn ghost",onClick:()=>o(a=>({...a,imageURLs:[]})),children:"Clear All"})]}),e.jsx("div",{className:"subtext",children:"Choose images in Image Manager, then click Done to add the URLs."}),Array.isArray(i.imageURLs)&&i.imageURLs.length>0&&e.jsx("div",{className:"image-grid",children:S(i.imageURLs).map((a,r)=>e.jsxs("div",{className:"image-tile",children:[e.jsx("img",{src:a==null?void 0:a.img,alt:`clinical-${r+1}`}),e.jsx("button",{type:"button",className:"image-remove",onClick:()=>de(r),children:"x"})]},`${(a==null?void 0:a.img)||"img"}-${r}`))}),(!Array.isArray(i.imageURLs)||i.imageURLs.length===0)&&e.jsx("div",{className:"image-empty",children:"No additional images added yet"})]})]}),e.jsx("div",{className:"card compact product-form-card",children:e.jsxs("form",{onSubmit:ge,className:"product-form-grid",children:[e.jsxs("div",{className:"section appear",children:[e.jsxs("div",{className:"section-title",children:[e.jsx("h3",{children:"Basics"}),e.jsx("span",{className:"hint",children:"Core clinical product details"})]}),e.jsxs("div",{className:"form-table",children:[e.jsxs("div",{className:"form-row",children:[e.jsx("div",{className:"form-cell",children:"Title *"}),e.jsx("div",{className:"form-cell",children:e.jsx("input",{name:"title",value:i.title,onChange:j,required:!0})})]}),e.jsxs("div",{className:"form-row",children:[e.jsx("div",{className:"form-cell",children:"Parent"}),e.jsx("div",{className:"form-cell",children:e.jsx("input",{name:"parent",value:i.parent,readOnly:!0})})]}),e.jsxs("div",{className:"form-row",children:[e.jsx("div",{className:"form-cell",children:"Sub Category"}),e.jsx("div",{className:"form-cell",children:e.jsx("input",{name:"children",value:i.children,readOnly:!0,placeholder:"Select category below"})})]}),e.jsxs("div",{className:"form-row",children:[e.jsx("div",{className:"form-cell",children:"Description *"}),e.jsx("div",{className:"form-cell",children:e.jsx("textarea",{name:"description",rows:5,value:i.description,onChange:j,required:!0})})]})]})]}),e.jsxs("div",{className:"section appear delay-2",style:{gridColumn:"1 / -1"},children:[e.jsxs("div",{className:"section-title",children:[e.jsx("h3",{children:"Brand & Category"}),e.jsx("span",{className:"hint",children:"Clinical categories are separate from B2C categories"})]}),e.jsxs("div",{className:"form-table",children:[e.jsxs("div",{className:"form-row",children:[e.jsx("div",{className:"form-cell",children:"Brand *"}),e.jsx("div",{className:"form-cell",children:e.jsxs("select",{value:i.brand.id||"",onChange:ce,required:!0,disabled:re,children:[e.jsx("option",{value:"",children:"-- Select brand --"}),I.map((a,r)=>{const t=a._id||a.id||a.uuid||`brand-${r}`;return e.jsx("option",{value:t,children:a.name||a.brandName||a.title||`Brand ${r+1}`},t)})]})})]}),e.jsxs("div",{className:"form-row",children:[e.jsx("div",{className:"form-cell",children:"Category *"}),e.jsx("div",{className:"form-cell",children:e.jsxs("select",{value:i.category.id||"",onChange:oe,required:!0,children:[e.jsx("option",{value:"",children:"-- Select category --"}),P.map(a=>e.jsx("option",{value:a.id,children:a.name},a.id))]})})]})]})]}),e.jsxs("div",{className:"section appear delay-3",style:{gridColumn:"1 / -1"},children:[e.jsxs("div",{className:"section-title",children:[e.jsx("h3",{children:"Inquiry Contact"}),e.jsx("span",{className:"hint",children:"At least one contact method is required"})]}),e.jsxs("div",{className:"form-table",children:[e.jsxs("div",{className:"form-row",children:[e.jsx("div",{className:"form-cell",children:"Contact Email"}),e.jsx("div",{className:"form-cell",children:e.jsx("input",{type:"email",name:"contactEmail",value:i.contactEmail,onChange:j,placeholder:"sales@example.com"})})]}),e.jsxs("div",{className:"form-row",children:[e.jsx("div",{className:"form-cell",children:"WhatsApp Number"}),e.jsx("div",{className:"form-cell",children:e.jsx("input",{name:"whatsappNumber",value:i.whatsappNumber,onChange:j,placeholder:"923001234567"})})]}),e.jsxs("div",{className:"form-row",children:[e.jsx("div",{className:"form-cell",children:"Inquiry Only"}),e.jsx("div",{className:"form-cell",children:e.jsx("input",{type:"checkbox",name:"inquiryOnly",checked:!!i.inquiryOnly,onChange:j})})]}),e.jsxs("div",{className:"form-row",children:[e.jsx("div",{className:"form-cell",children:"Professional Use Only"}),e.jsx("div",{className:"form-cell",children:e.jsx("input",{type:"checkbox",name:"professionalUseOnly",checked:!!i.professionalUseOnly,onChange:j})})]})]})]}),e.jsx("div",{className:"sticky-actions appear",style:{gridColumn:"1 / -1"},children:e.jsxs("div",{className:"actions",children:[e.jsx("button",{className:"btn",type:"submit",disabled:T,children:T?"Saving...":"Save Clinical Product"}),e.jsx("button",{className:"btn secondary",type:"button",onClick:()=>window.location.href="/admin/clinical-products",children:"Cancel"})]})})]})})]}),L&&e.jsx("div",{className:"image-manager-modal-overlay",role:"dialog","aria-modal":"true",onClick:U,children:e.jsxs("div",{className:"image-manager-modal-card",onClick:a=>a.stopPropagation(),children:[e.jsxs("div",{className:"section-title",children:[e.jsx("h3",{children:y?"Select Main Image":"Select Additional Images"}),e.jsx("span",{className:"hint",children:y?"Click one image to auto-fill Main Image URL.":"Select multiple images and add all selected URLs automatically."})]}),e.jsxs("div",{className:"image-input-row image-input-row-three",children:[e.jsx("input",{value:R,onChange:a=>K(a.target.value),onKeyDown:a=>{a.key==="Enter"&&(a.preventDefault(),$(a.currentTarget.value))},placeholder:"Search by image id or URL"}),e.jsx("button",{type:"button",className:"btn ghost",onClick:()=>$(R),disabled:O,children:O?"Loading...":"Search"}),e.jsx("button",{type:"button",className:"btn secondary",onClick:U,children:"Close"})]}),J&&e.jsx("div",{className:"error",style:{marginTop:8},children:J}),e.jsx("div",{className:"image-manager-modal-body",children:e.jsxs("div",{className:"image-manager-grid",children:[Q.map((a,r)=>e.jsxs("button",{type:"button",className:`image-tile selectable ${!y&&v[a.url]?"selected":""}`,onClick:()=>me(a.url),children:[e.jsx("img",{src:a.url,alt:a.publicId||`manager-image-${r+1}`}),e.jsx("span",{className:"image-select-chip",children:y?"Set Main":v[a.url]?"Selected":"Select"})]},`${a.id}-${r}`)),!O&&!Q.length&&e.jsx("div",{className:"image-empty",children:"No images found in image manager."})]})}),!y&&e.jsxs("div",{className:"image-manager-modal-footer",children:[e.jsxs("span",{className:"subtext",children:[C," selected"]}),e.jsx("button",{type:"button",className:"btn",onClick:ue,disabled:!C,children:C?C===1?"Done (1 image)":`Done (${C} images)`:"Done"})]})]})})]})};export{Ce as default};
