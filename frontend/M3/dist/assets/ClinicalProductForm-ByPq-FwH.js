import{a as xe,r as d,j as e,A as f}from"./index-CPlrO2ek.js";/* empty css                */import{p as ve}from"./api-error-B8TEswhR.js";const ie={img:"",title:"",parent:"Clinical",children:"",unit:"n/a",price:0,discount:0,quantity:0,status:"in-stock",brand:{name:"",id:""},category:{name:"",id:""},description:"",imageURLs:[],contactEmail:"",whatsappNumber:"",inquiryOnly:!0,isInquiryOnly:!0,professionalUseOnly:!0},re=r=>r?Array.isArray(r)?r:Array.isArray(r.result)?r.result:Array.isArray(r.data)?r.data:r.data&&Array.isArray(r.data.result)?r.data.result:r.data&&Array.isArray(r.data.data)?r.data.data:[]:[],Ne=r=>!r||typeof r!="object"?[]:Array.isArray(r.images)?r.images:Array.isArray(r.data)?r.data:r.data&&Array.isArray(r.data.images)?r.data.images:[],te=r=>{const g=typeof r=="string"?r:(r==null?void 0:r.img)||(r==null?void 0:r.url)||"",i=String(g||"").trim();return i?{...typeof r=="object"&&r?r:{},img:i,color:typeof r=="object"&&(r==null?void 0:r.color)||{name:"default",clrCode:""},sizes:typeof r=="object"&&Array.isArray(r==null?void 0:r.sizes)&&r.sizes||[]}:null},I=r=>{const g=Array.isArray(r)?r:[],i=new Set,u=[];return g.forEach(A=>{const j=te(A);if(!(j!=null&&j.img))return;const b=j.img.toLowerCase();i.has(b)||(i.add(b),u.push(j))}),u},Ce=()=>{var ee,ae;const{id:r}=xe(),g=!!r,[i,u]=d.useState(ie),[A,j]=d.useState([]),[b,P]=d.useState([]),[B,T]=d.useState(!1),[F,L]=d.useState(!1),[ne,D]=d.useState(!1),[ce,_]=d.useState(!1),[z,v]=d.useState(""),[K,k]=d.useState([]),[q,H]=d.useState(!1),[$,J]=d.useState("additional"),[E,Q]=d.useState(!1),[W,w]=d.useState(""),[M,Y]=d.useState(""),[V,G]=d.useState([]),[N,R]=d.useState({}),x=()=>{try{const a=localStorage.getItem("adminToken");return a?{Authorization:`Bearer ${a}`}:{}}catch{return{}}},le=a=>{const s=Array.isArray(a)?a.map(n=>String(n||"").trim()).filter(Boolean):[];s.length&&u(n=>{const c=I(n.imageURLs),l=new Set(c.map(t=>t.img.toLowerCase())),o=[...c];return s.forEach(t=>{const h=t.toLowerCase();l.has(h)||(l.add(h),o.push(te(t)))}),{...n,imageURLs:o}})},oe=async()=>{D(!0);try{const a=await fetch(`${f}/brand/all`,{headers:{...x()},cache:"no-store"}),s=await a.json().catch(()=>null);if(!a.ok)throw new Error((s==null?void 0:s.message)||"Failed to load brands");j(re(s))}catch{j([])}finally{D(!1)}},de=async()=>{_(!0);try{const a=await fetch(`${f}/category/all`,{headers:{...x()},cache:"no-store"}),s=await a.json().catch(()=>null);if(!a.ok)throw new Error((s==null?void 0:s.message)||"Failed to load categories");P(re(s))}catch{P([])}finally{_(!1)}},me=async()=>{if(g){T(!0),v("");try{let a=await fetch(`${f}/clinical-products/${r}`,{headers:{...x()},cache:"no-store"}),s=await a.json().catch(()=>({}));if(!a.ok&&a.status===404&&(a=await fetch(`${f}/product/single-product/${r}`,{headers:{...x()},cache:"no-store"}),s=await a.json().catch(()=>({}))),!a.ok)throw new Error((s==null?void 0:s.message)||"Failed to load clinical product");const n=(s==null?void 0:s.data)||s;u({...ie,...n,brand:(n==null?void 0:n.brand)||{name:"",id:""},category:(n==null?void 0:n.category)||{name:"",id:""},imageURLs:I(n==null?void 0:n.imageURLs)})}catch(a){v(a.message||"Failed to load clinical product")}finally{T(!1)}}},O=async(a=M)=>{Q(!0),w("");try{const s=new URL(`${f}/cloudinary/images`);String(a||"").trim()&&s.searchParams.set("q",String(a).trim());const n=await fetch(s.toString(),{headers:{...x()},cache:"no-store"}),c=await n.json().catch(()=>({}));if(!n.ok)throw new Error((c==null?void 0:c.message)||(c==null?void 0:c.error)||"Failed to load image manager");const l=Ne(c).map((t,h)=>({id:(t==null?void 0:t._id)||(t==null?void 0:t.publicId)||(t==null?void 0:t.id)||`manager-image-${h}`,publicId:(t==null?void 0:t.publicId)||(t==null?void 0:t.id)||"",url:String((t==null?void 0:t.url)||(t==null?void 0:t.img)||"").trim()})).filter(t=>t.url),o=new Map;l.forEach(t=>{o.has(t.url)||o.set(t.url,t)}),G(Array.from(o.values()))}catch(s){w(s.message||"Failed to load image manager"),G([])}finally{Q(!1)}};d.useEffect(()=>{oe(),de(),me()},[r]),d.useEffect(()=>{q&&O()},[q]);const p=a=>{const{name:s,value:n,type:c,checked:l}=a.target;if(c==="checkbox"){u(o=>({...o,[s]:l}));return}u(o=>({...o,[s]:n}))},X=(a,s)=>{const n=a.target.value,l=(s==="brand"?A:b).find(t=>(t._id||t.id||t.uuid)===n),o=l?{id:l._id||l.id||l.uuid||"",name:l.name||l.parent||l.title||""}:{id:"",name:""};u(t=>({...t,[s]:o}))},ue=a=>{u(s=>({...s,imageURLs:I(s.imageURLs).filter((n,c)=>c!==a)}))},Z=(a="additional")=>{J(a==="main"?"main":"additional"),R({}),w(""),H(!0)},U=()=>{H(!1),J("additional"),R({}),w(""),Y("")},he=a=>{const s=String(a||"").trim();if(s){if($==="main"){u(n=>({...n,img:s})),U();return}R(n=>({...n,[s]:!n[s]}))}},ge=()=>{if($==="main")return;const a=Object.keys(N).filter(s=>N[s]);if(!a.length){w("Select at least one image.");return}le(a),U()},y=Object.keys(N).filter(a=>N[a]).length,C=$==="main",pe=()=>{var s,n,c,l,o,t,h,m,S;const a=[];return(s=i.img)!=null&&s.trim()||a.push("Main image URL is required"),(n=i.title)!=null&&n.trim()||a.push("Title is required"),(c=i.parent)!=null&&c.trim()||a.push("Parent is required"),(l=i.children)!=null&&l.trim()||a.push("Children is required"),(o=i.description)!=null&&o.trim()||a.push("Description is required"),(!((t=i.brand)!=null&&t.id)||!((h=i.brand)!=null&&h.name))&&a.push("Brand is required"),(!((m=i.category)!=null&&m.id)||!((S=i.category)!=null&&S.name))&&a.push("Category is required"),!i.contactEmail&&!i.whatsappNumber&&a.push("Provide at least one contact method (Email or WhatsApp)"),a},fe=async a=>{a.preventDefault(),L(!0),v(""),k([]);const s=pe();if(s.length){v("Please fix the highlighted clinical product details before saving."),k(s),L(!1),window.scrollTo({top:0,behavior:"smooth"});return}const n=Number(i.price),c=Number(i.discount),l=Number(i.quantity),o={img:i.img,title:i.title,parent:i.parent,children:i.children,unit:String(i.unit||"").trim()||"n/a",price:Number.isFinite(n)?n:0,discount:Number.isFinite(c)?c:0,quantity:Number.isFinite(l)?l:0,status:i.status||"in-stock",brand:i.brand,category:i.category,productType:"clinical",description:i.description,imageURLs:I(i.imageURLs),contactEmail:i.contactEmail||"",whatsappNumber:i.whatsappNumber||"",inquiryOnly:!!i.inquiryOnly,isInquiryOnly:!!i.isInquiryOnly,professionalUseOnly:!!i.professionalUseOnly};try{let t=g?`${f}/clinical-products/${r}`:`${f}/clinical-products`,h=g?"PUT":"POST",m=await fetch(t,{method:h,headers:{"Content-Type":"application/json",...x()},body:JSON.stringify(o)}),S=await m.json().catch(()=>({}));if(!m.ok&&m.status===404&&(t=g?`${f}/product/edit-product/${r}`:`${f}/product/add`,h=g?"PATCH":"POST",m=await fetch(t,{method:h,headers:{"Content-Type":"application/json",...x()},body:JSON.stringify(o)}),S=await m.json().catch(()=>({}))),!m.ok){const je=m.status===401?"Your session has expired. Please log in again.":m.status===403?"You do not have permission to add or edit clinical products.":`Save failed (${m.status}). Please review and try again.`,se=ve(S,je);v(se.summary),k(se.issues),window.scrollTo({top:0,behavior:"smooth"});return}window.location.href="/admin/clinical-products"}catch(t){v(t.message||"Failed to save clinical product"),k([]),window.scrollTo({top:0,behavior:"smooth"})}finally{L(!1)}};return e.jsxs("div",{className:"page-container",children:[e.jsxs("div",{className:"page-header fancy",children:[e.jsxs("div",{children:[e.jsx("h2",{children:g?"Edit Clinical Product":"Add Clinical Product"}),e.jsx("p",{className:"muted",children:"Clinical products are displayed to customers as inquiry-first items."})]}),e.jsx("button",{className:"btn secondary",type:"button",onClick:()=>window.location.href="/admin/clinical-products",children:"â† Back"})]}),B&&e.jsx("div",{children:"Loading..."}),z&&e.jsxs("div",{className:"error-panel",role:"alert","aria-live":"polite",children:[e.jsx("p",{className:"error-panel-title",children:z}),K.length>0&&e.jsx("ul",{className:"error-panel-list",children:K.map((a,s)=>e.jsx("li",{children:a},`${a}-${s}`))})]}),!B&&e.jsxs("div",{className:"product-form-shell",children:[e.jsxs("div",{className:"product-side",children:[e.jsxs("div",{className:"card product-preview-card",children:[e.jsx("div",{className:"product-preview-media",children:i.img?e.jsx("img",{src:i.img,alt:"Clinical product preview",onError:a=>{a.currentTarget.style.visibility="hidden"}}):e.jsx("div",{className:"preview-placeholder",children:"No main image"})}),e.jsxs("div",{className:"product-preview-body",children:[e.jsx("span",{className:"product-preview-title",children:i.title||"Untitled Clinical Product"}),e.jsxs("div",{className:"product-preview-row",children:[e.jsx("span",{children:"Brand"}),e.jsx("strong",{children:((ee=i.brand)==null?void 0:ee.name)||"Unassigned"})]}),e.jsxs("div",{className:"product-preview-row",children:[e.jsx("span",{children:"Category"}),e.jsx("strong",{children:((ae=i.category)==null?void 0:ae.name)||"Unassigned"})]})]})]}),e.jsxs("div",{className:"card product-media-card",children:[e.jsxs("div",{className:"section-title",children:[e.jsx("h3",{children:"Media"}),e.jsx("span",{className:"hint",children:"Use the same image flow as products"})]}),e.jsx("label",{children:"Main Image URL *"}),e.jsxs("div",{className:"image-input-row image-main-url-row",children:[e.jsx("input",{name:"img",placeholder:"https://example.com/image.jpg",value:i.img,onChange:p}),e.jsx("button",{type:"button",className:"btn secondary",onClick:()=>Z("main"),children:"Select Image URL"})]}),e.jsx("div",{className:"preview-row",children:e.jsx("div",{className:"preview",children:i.img?e.jsx("img",{src:i.img,alt:"Main Image Preview",onError:a=>{a.currentTarget.style.visibility="hidden"}}):e.jsx("div",{className:"preview-placeholder",children:"No main image"})})}),e.jsx("label",{children:"Additional Images"}),e.jsxs("div",{className:"actions",style:{marginTop:8},children:[e.jsx("button",{type:"button",className:"btn secondary",onClick:()=>Z("additional"),children:"Select Multiple Images"}),Array.isArray(i.imageURLs)&&i.imageURLs.length>0&&e.jsx("button",{type:"button",className:"btn ghost",onClick:()=>u(a=>({...a,imageURLs:[]})),children:"Clear All"})]}),e.jsx("div",{className:"subtext",children:"Choose images in Image Manager, then click Done to add the URLs."}),Array.isArray(i.imageURLs)&&i.imageURLs.length>0&&e.jsx("div",{className:"image-grid",children:I(i.imageURLs).map((a,s)=>e.jsxs("div",{className:"image-tile",children:[e.jsx("img",{src:a==null?void 0:a.img,alt:`clinical-${s+1}`}),e.jsx("button",{type:"button",className:"image-remove",onClick:()=>ue(s),children:"x"})]},`${(a==null?void 0:a.img)||"img"}-${s}`))}),(!Array.isArray(i.imageURLs)||i.imageURLs.length===0)&&e.jsx("div",{className:"image-empty",children:"No additional images added yet"})]})]}),e.jsx("div",{className:"card compact product-form-card",children:e.jsxs("form",{onSubmit:fe,className:"product-form-grid",children:[e.jsxs("div",{className:"section appear",children:[e.jsxs("div",{className:"section-title",children:[e.jsx("h3",{children:"Basics"}),e.jsx("span",{className:"hint",children:"Core clinical product details"})]}),e.jsxs("div",{className:"form-table",children:[e.jsxs("div",{className:"form-row",children:[e.jsx("div",{className:"form-cell",children:"Title *"}),e.jsx("div",{className:"form-cell",children:e.jsx("input",{name:"title",value:i.title,onChange:p,required:!0})})]}),e.jsxs("div",{className:"form-row",children:[e.jsx("div",{className:"form-cell",children:"Parent *"}),e.jsx("div",{className:"form-cell",children:e.jsx("input",{name:"parent",value:i.parent,onChange:p,required:!0})})]}),e.jsxs("div",{className:"form-row",children:[e.jsx("div",{className:"form-cell",children:"Children *"}),e.jsx("div",{className:"form-cell",children:e.jsx("input",{name:"children",value:i.children,onChange:p,required:!0})})]}),e.jsxs("div",{className:"form-row",children:[e.jsx("div",{className:"form-cell",children:"Description *"}),e.jsx("div",{className:"form-cell",children:e.jsx("textarea",{name:"description",rows:5,value:i.description,onChange:p,required:!0})})]})]})]}),e.jsxs("div",{className:"section appear delay-2",style:{gridColumn:"1 / -1"},children:[e.jsxs("div",{className:"section-title",children:[e.jsx("h3",{children:"Brand & Category"}),e.jsx("span",{className:"hint",children:"Map the product to its catalog references"})]}),e.jsxs("div",{className:"form-table",children:[e.jsxs("div",{className:"form-row",children:[e.jsx("div",{className:"form-cell",children:"Brand *"}),e.jsx("div",{className:"form-cell",children:e.jsxs("select",{value:i.brand.id||"",onChange:a=>X(a,"brand"),required:!0,disabled:ne,children:[e.jsx("option",{value:"",children:"-- Select brand --"}),A.map((a,s)=>{const n=a._id||a.id||a.uuid||`brand-${s}`;return e.jsx("option",{value:n,children:a.name||a.brandName||a.title||`Brand ${s+1}`},n)})]})})]}),e.jsxs("div",{className:"form-row",children:[e.jsx("div",{className:"form-cell",children:"Category *"}),e.jsx("div",{className:"form-cell",children:e.jsxs("select",{value:i.category.id||"",onChange:a=>X(a,"category"),required:!0,disabled:ce,children:[e.jsx("option",{value:"",children:"-- Select category --"}),b.map((a,s)=>{const n=a._id||a.id||a.uuid||`category-${s}`;return e.jsx("option",{value:n,children:a.parent||a.name||a.title||`Category ${s+1}`},n)})]})})]})]})]}),e.jsxs("div",{className:"section appear delay-3",style:{gridColumn:"1 / -1"},children:[e.jsxs("div",{className:"section-title",children:[e.jsx("h3",{children:"Inquiry Contact"}),e.jsx("span",{className:"hint",children:"At least one contact method is required"})]}),e.jsxs("div",{className:"form-table",children:[e.jsxs("div",{className:"form-row",children:[e.jsx("div",{className:"form-cell",children:"Contact Email"}),e.jsx("div",{className:"form-cell",children:e.jsx("input",{type:"email",name:"contactEmail",value:i.contactEmail,onChange:p,placeholder:"sales@example.com"})})]}),e.jsxs("div",{className:"form-row",children:[e.jsx("div",{className:"form-cell",children:"WhatsApp Number"}),e.jsx("div",{className:"form-cell",children:e.jsx("input",{name:"whatsappNumber",value:i.whatsappNumber,onChange:p,placeholder:"923001234567"})})]}),e.jsxs("div",{className:"form-row",children:[e.jsx("div",{className:"form-cell",children:"Inquiry Only"}),e.jsx("div",{className:"form-cell",children:e.jsx("input",{type:"checkbox",name:"inquiryOnly",checked:!!i.inquiryOnly,onChange:p})})]}),e.jsxs("div",{className:"form-row",children:[e.jsx("div",{className:"form-cell",children:"Professional Use Only"}),e.jsx("div",{className:"form-cell",children:e.jsx("input",{type:"checkbox",name:"professionalUseOnly",checked:!!i.professionalUseOnly,onChange:p})})]})]})]}),e.jsx("div",{className:"sticky-actions appear",style:{gridColumn:"1 / -1"},children:e.jsxs("div",{className:"actions",children:[e.jsx("button",{className:"btn",type:"submit",disabled:F,children:F?"Saving...":"Save Clinical Product"}),e.jsx("button",{className:"btn secondary",type:"button",onClick:()=>window.location.href="/admin/clinical-products",children:"Cancel"})]})})]})})]}),q&&e.jsx("div",{className:"image-manager-modal-overlay",role:"dialog","aria-modal":"true",onClick:U,children:e.jsxs("div",{className:"image-manager-modal-card",onClick:a=>a.stopPropagation(),children:[e.jsxs("div",{className:"section-title",children:[e.jsx("h3",{children:C?"Select Main Image":"Select Additional Images"}),e.jsx("span",{className:"hint",children:C?"Click one image to auto-fill Main Image URL.":"Select multiple images and add all selected URLs automatically."})]}),e.jsxs("div",{className:"image-input-row image-input-row-three",children:[e.jsx("input",{value:M,onChange:a=>Y(a.target.value),onKeyDown:a=>{a.key==="Enter"&&(a.preventDefault(),O(a.currentTarget.value))},placeholder:"Search by image id or URL"}),e.jsx("button",{type:"button",className:"btn ghost",onClick:()=>O(M),disabled:E,children:E?"Loading...":"Search"}),e.jsx("button",{type:"button",className:"btn secondary",onClick:U,children:"Close"})]}),W&&e.jsx("div",{className:"error",style:{marginTop:8},children:W}),e.jsx("div",{className:"image-manager-modal-body",children:e.jsxs("div",{className:"image-manager-grid",children:[V.map((a,s)=>e.jsxs("button",{type:"button",className:`image-tile selectable ${!C&&N[a.url]?"selected":""}`,onClick:()=>he(a.url),children:[e.jsx("img",{src:a.url,alt:a.publicId||`manager-image-${s+1}`}),e.jsx("span",{className:"image-select-chip",children:C?"Set Main":N[a.url]?"Selected":"Select"})]},`${a.id}-${s}`)),!E&&!V.length&&e.jsx("div",{className:"image-empty",children:"No images found in image manager."})]})}),!C&&e.jsxs("div",{className:"image-manager-modal-footer",children:[e.jsxs("span",{className:"subtext",children:[y," selected"]}),e.jsx("button",{type:"button",className:"btn",onClick:ge,disabled:!y,children:y?y===1?"Done (1 image)":`Done (${y} images)`:"Done"})]})]})})]})};export{Ce as default};
